// Language pack (AR/EN)
const i18n = {
  ar: {
    'site.title': 'ETL — كتالوج الشركات',
    'nav.home': 'الرئيسية', 'nav.about': 'من نحن', 'nav.catalogue': 'الكتالوج', 'nav.privacy': 'الخصوصية والسياسة', 'nav.contact': 'اتصل بنا',
    'home.heroTitle': 'كتالوج B2B أنيق لعرض منتجات ETL',
    'home.heroText': 'استعرض مجموعاتك بسرعة وأناقة، مع دعم التحميل كملف PDF ولغتين.',
    'home.ctaBrowse': 'تصفح الأقسام', 'home.ctaDownload': 'تحميل الكتالوج',
    'home.chipFast': 'خفيف وسريع', 'home.chipB2B': 'تصميم B2B', 'home.chipBi': 'ثنائي اللغة', 'home.chipPdf': 'PDF جاهز',
    'home.secTitle': 'لماذا تختار كتالوج ETL؟', 'home.secText': 'تنظيم واضح للأقسام، تجربة سلسة، وألوان كريمية فخمة.', 'home.cardView': 'عرض المنتجات →',
    'home.card1Title': 'ماكينات التغليف', 'home.card1Text': 'حلول متقدمة للتعبئة والتغليف الصناعي.',
    'home.card2Title': 'خطوط الإنتاج', 'home.card2Text': 'خطوط متكاملة تناسب احتياجاتك.',
    'home.card3Title': 'المواد الخام', 'home.card3Text': 'توريد مواد بجودة موثوقة وثابتة.',
    'home.card4Title': 'الملحقات والقطع', 'home.card4Text': 'قطع غيار وصيانة مضمونة.',
    'footer.tag': 'حلول كتالوج احترافية للشركات.', 'footer.quick': 'روابط', 'footer.contact': 'تواصل', 'footer.whatsapp': 'واتساب', 'footer.email': 'إيميل',

    'about.title':'عن ETL', 'about.h1':'من نحن', 'about.lead':'ETL شركة متخصصة في حلول الكتالوج الصناعي B2B، نقدم واجهات أنيقة وتجربة استخدام ممتازة.', 'about.mission':'رسالتنا', 'about.missionText':'تمكين الشركات من عرض منتجاتها باحترافية لزيادة الثقة والمبيعات.', 'about.vision':'رؤيتنا', 'about.visionText':'أن نكون المنصة المفضلة لكتالوجات الشركات في المنطقة.',

    'catalogue.title':'كتالوج ETL', 'catalogue.h1':'كتالوج ETL', 'catalogue.lead':'حمل الكتالوج حسب السنة أو استعرض الأقسام.', 'catalogue.cat1':'معدات التعبئة', 'catalogue.cat1Text':'معدات عالية الكفاءة لمختلف الاستخدامات.', 'catalogue.cat2':'خطوط الإنتاج', 'catalogue.cat2Text':'حلول متكاملة بتكلفة مناسبة.', 'catalogue.cat3':'مواد خام', 'catalogue.cat3Text':'توريد موثوق طويل الأمد.', 'catalogue.cat4':'ملحقات', 'catalogue.cat4Text':'قطع غيار وصيانة.', 'catalogue.view':'عرض المنتجات →',

    'privacy.title':'الخصوصية والسياسة', 'privacy.h1':'سياسة الخصوصية', 'privacy.p1':'نحترم خصوصيتك ونلتزم بحماية بياناتك. تشرح هذه السياسة كيفية جمع واستخدام المعلومات.', 'privacy.h2':'المعلومات التي نجمعها', 'privacy.li1':'بيانات التواصل الأساسية.', 'privacy.li2':'استفسارات الكتالوج والطلبات.', 'privacy.h3':'حقوقك', 'privacy.p2':'يمكنك طلب الوصول أو التصحيح أو الحذف لبياناتك في أي وقت عبر البريد الإلكتروني.',

    'contact.title':'اتصل بنا', 'contact.h1':'راسلنا', 'contact.name':'الاسم', 'contact.msg':'رسالتك', 'contact.send':'إرسال',
  },
  en: {
    'site.title': 'ETL — Company Catalogue',
    'nav.home': 'Home', 'nav.about': 'About Us', 'nav.catalogue': 'Catalogue', 'nav.privacy': 'Privacy & Policy', 'nav.contact': 'Contact Us',
    'home.heroTitle': 'Elegant B2B Catalogue for ETL Products',
    'home.heroText': 'Showcase your collections with speed and style, with PDF downloads and bilingual support.',
    'home.ctaBrowse': 'Browse Sections', 'home.ctaDownload': 'Download PDF',
    'home.chipFast': 'Fast & Lightweight', 'home.chipB2B': 'B2B Design', 'home.chipBi': 'Bilingual', 'home.chipPdf': 'PDF Ready',
    'home.secTitle': 'Why choose ETL Catalogue?', 'home.secText': 'Clear structure, smooth UX, and refined creamy palette.', 'home.cardView': 'View products →',
    'home.card1Title': 'Packaging Machines', 'home.card1Text': 'Advanced solutions for industrial packaging.',
    'home.card2Title': 'Production Lines', 'home.card2Text': 'Integrated lines tailored to your needs.',
    'home.card3Title': 'Raw Materials', 'home.card3Text': 'Reliable supply with consistent quality.',
    'home.card4Title': 'Accessories & Parts', 'home.card4Text': 'Guaranteed spare parts & service.',
    'footer.tag': 'Professional catalogue solutions for businesses.', 'footer.quick': 'Quick Links', 'footer.contact': 'Contact', 'footer.whatsapp': 'WhatsApp', 'footer.email': 'Email',

    'about.title':'About ETL', 'about.h1':'About Us', 'about.lead':'ETL specializes in B2B industrial catalogue solutions, delivering elegant UIs and great UX.', 'about.mission':'Our Mission', 'about.missionText':'Empower companies to present products professionally to boost trust and sales.', 'about.vision':'Our Vision', 'about.visionText':'To be the preferred corporate catalogue platform in the region.',

    'catalogue.title':'ETL Catalogue', 'catalogue.h1':'ETL Catalogue', 'catalogue.lead':'Download yearly catalogues or browse sections.', 'catalogue.cat1':'Packaging Equipment', 'catalogue.cat1Text':'High-efficiency equipment for varied use cases.', 'catalogue.cat2':'Production Lines', 'catalogue.cat2Text':'Integrated, cost-effective solutions.', 'catalogue.cat3':'Raw Materials', 'catalogue.cat3Text':'Reliable long-term supply.', 'catalogue.cat4':'Accessories', 'catalogue.cat4Text':'Spare parts & maintenance.', 'catalogue.view':'View products →',

    'privacy.title':'Privacy & Policy', 'privacy.h1':'Privacy Policy', 'privacy.p1':'We respect your privacy and are committed to protecting your data. This policy explains how information is collected and used.', 'privacy.h2':'Information we collect', 'privacy.li1':'Basic contact details.', 'privacy.li2':'Catalogue inquiries and requests.', 'privacy.h3':'Your rights', 'privacy.p2':'You may request access, correction, or deletion of your data at any time via email.',

    'contact.title':'Contact Us', 'contact.h1':'Contact Us', 'contact.name':'Name', 'contact.msg':'Your Message', 'contact.send':'Send',
  }
};

// Inject shared footer into pages that have {{FOOTER}}
function injectFooter(){
  document.querySelectorAll('footer.site-footer').forEach(foot=>{
    if(foot.innerHTML.includes('{{FOOTER}}')){
      foot.innerHTML = document.querySelector('.site-footer').innerHTML;
    }
  });
}

function setYear(){
  const yEl = document.getElementById('year');
  if(yEl) yEl.textContent = new Date().getFullYear();
}

function applyTranslations(lang){
  const map = i18n[lang] || i18n.ar;
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    if(map[key]){
      if(el.tagName.toLowerCase()==='title') document.title = map[key];
      else el.textContent = map[key];
    }
  });
}

function restoreLang(){
  const saved = localStorage.getItem('etl_lang') || 'ar';
  document.documentElement.lang = saved;
  document.documentElement.dir = saved === 'ar' ? 'rtl' : 'ltr';
  const btn = document.getElementById('langBtn');
  if(btn) btn.textContent = saved === 'ar' ? 'EN' : 'AR';
  applyTranslations(saved);
}

function toggleLang(){
  const html = document.documentElement;
  const newLang = html.lang === 'ar' ? 'en' : 'ar';
  html.lang = newLang;
  html.dir = newLang === 'ar' ? 'rtl' : 'ltr';
  localStorage.setItem('etl_lang', newLang);

  const btn = document.getElementById('langBtn');
  if(btn) btn.textContent = newLang === 'ar' ? 'EN' : 'AR';

  // هنا مكان الإضافة
  applyTranslations(newLang);
  renderCatalogueYears(); // إعادة بناء الكروت بالعناوين الصحيحة
}



function wireLangButton(){
  const btn = document.getElementById('langBtn');
  if(btn) btn.addEventListener('click', toggleLang);
}

function markActiveNav(){
  const path = location.pathname.split('/').pop() || 'index.html';
  document.querySelectorAll('.nav a').forEach(a=>{
    const href = a.getAttribute('href');
    if((path === '' && href.endsWith('index.html')) || href.endsWith(path)) a.classList.add('active');
  });
}

// Catalogue page: render yearly downloads (edit years as needed)
function renderCatalogueYears(){
  const yearsWrap = document.querySelector('#downloads');
  if(!yearsWrap) return;
  const now = new Date().getFullYear();
  const start = now - 6; // last 7 years
  const lang = document.documentElement.lang || 'ar';
  const t = (ar,en)=> (lang==='ar'? ar : en);
  let out = '';
  for(let y=now; y>=start; y--){
    out += `
    <article class="year-card">
      <h4>${t('كتالوج','Catalogue')} ${y}</h4>
      <p class="muted">${t('نسخة PDF عالية الجودة','High-quality PDF edition')}</p>
      <div class="year-actions">
        <a class="btn primary" href="media/catalogue/${y}.pdf" download>
          ${t('تحميل','Download')}
        </a>
        <a class="btn ghost" href="media/catalogue/${y}.pdf" target="_blank" rel="noopener">
          ${t('معاينة','Preview')}
        </a>
      </div>
    </article>`;
  }
  yearsWrap.innerHTML = out;
}

function handleContactForm(){
  const form = document.getElementById('contactForm');
  if(!form) return;
  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    alert(document.documentElement.lang==='ar' ? 'تم إرسال رسالتك بنجاح (نموذج تجريبي).' : 'Your message has been sent (demo form).');
    form.reset();
  });
}
/* ===== Step 2: Local data + filters + products ===== */
const LS_PRODUCTS = 'etl_products';
const LS_CATS = 'etl_categories';

function getProducts(){ return JSON.parse(localStorage.getItem(LS_PRODUCTS)||'[]'); }
function saveProducts(list){ localStorage.setItem(LS_PRODUCTS, JSON.stringify(list)); }
function getCategories(){ return JSON.parse(localStorage.getItem(LS_CATS)||'[]'); }
function saveCategories(list){ localStorage.setItem(LS_CATS, JSON.stringify(list)); }

// Seed demo data once (only if empty)
(function seedDemo(){
  if(!localStorage.getItem(LS_CATS)) saveCategories(['Packaging','Production','Raw','Accessories']);
  if(!localStorage.getItem(LS_PRODUCTS)){
    const y = new Date().getFullYear();
    saveProducts([
      {id:'p1', name_ar:'ماكينة تعبئة أوتوماتيك', name_en:'Automatic Filler', category:'Packaging', model:'ETL-A100', year:y,   imageData:'', desc_ar:'', desc_en:''},
      {id:'p2', name_ar:'خط إنتاج سريع',        name_en:'Fast Production Line', category:'Production', model:'ETL-P300', year:y-1, imageData:'', desc_ar:'', desc_en:''},
      {id:'p3', name_ar:'راتنج خام صناعي',      name_en:'Industrial Resin',     category:'Raw',        model:'ETL-R220', year:y-2, imageData:'', desc_ar:'', desc_en:''},
      {id:'p4', name_ar:'سير نقل احتياطي',      name_en:'Spare Conveyor Belt',  category:'Accessories', model:'ETL-XB12', year:y,   imageData:'', desc_ar:'', desc_en:''}
    ]);
  }
})();

function populateFilters(){
  const catSel = document.getElementById('fCategory');
  const yearSel = document.getElementById('fYear');
  if(!catSel || !yearSel) return;

  const lang = document.documentElement.lang || 'ar';
  const cats = getCategories();
  catSel.innerHTML = `<option value="">${lang==='ar'?'الكل':'All'}</option>` + cats.map(c=>`<option>${c}</option>`).join('');

  const years = [...new Set(getProducts().map(p=>p.year))].sort((a,b)=>b-a);
  yearSel.innerHTML = `<option value="">${lang==='ar'?'الكل':'All'}</option>` + years.map(y=>`<option>${y}</option>`).join('');
}

function productMatches(p, q, cat, yr){
  const lang = document.documentElement.lang || 'ar';
  const name = (lang==='ar' ? p.name_ar : p.name_en) || '';
  const model = p.model || '';
  let ok = true;
  if(cat) ok = ok && p.category === cat;
  if(yr)  ok = ok && String(p.year) === String(yr);
  if(q){ const hay = (name + ' ' + model).toLowerCase(); ok = ok && hay.includes(q.toLowerCase()); }
  return ok;
}

function renderProducts(){
  const grid = document.getElementById('productsGrid');
  if(!grid) return;

  const q   = document.getElementById('fQuery')?.value || '';
  const cat = document.getElementById('fCategory')?.value || '';
  const yr  = document.getElementById('fYear')?.value || '';
  const lang = document.documentElement.lang || 'ar';
  const t = (ar,en)=> lang==='ar'?ar:en;

  const list = getProducts().filter(p=>productMatches(p,q,cat,yr));
  if(list.length===0){
    grid.innerHTML = `<p class="muted">${t('لا توجد نتائج مطابقة','No matching results')}</p>`;
    return;
  }
  grid.innerHTML = list.map(p=>`
    <article class="product-card">
      <img class="p-img" src="${p.imageData||''}" alt="${(lang==='ar'?p.name_ar:p.name_en)||'Product'}"/>
      <div class="p-body">
        <h4>${(lang==='ar'?p.name_ar:p.name_en)||'-'}</h4>
        <div class="p-meta"><span>${p.category||'-'}</span><span>•</span><span>${p.model||'-'}</span><span>•</span><span>${p.year||'-'}</span></div>
      </div>
    </article>`).join('');
}

function wireFilters(){
  ['fQuery','fCategory','fYear'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener('input', renderProducts);
  });
  const reset = document.getElementById('btnReset');
  if(reset) reset.addEventListener('click', ()=>{
    ['fQuery','fCategory','fYear'].forEach(id=>{
      const el = document.getElementById(id); if(el) el.value = '';
    });
    renderProducts();
  });
}

function boot(){
  setYear();
  restoreLang();
  wireLangButton();
  markActiveNav();
  renderCatalogueYears();

  // Step 2 hooks (catalogue page only — harmless on other pages)
  populateFilters();
  wireFilters();
  renderProducts();

  handleContactForm();
}
document.addEventListener('DOMContentLoaded', boot);
